# [2024-03-18]:윤주석 작업일지

## 오늘 할 일

- [x]  1 카프카 설치
- [x]  2 채팅 내역 조회
- [x]  3 채팅 서비스 작성

## 내일 할 일

- [ ]  1 카프카 소켓 설정 및 메시지 브로커 세팅
- [ ]  2 채팅 내역 생성
- [ ]  3

## 업무 상세

---

### 메모

## 멤버 테이블 예비 데이터 생성

```jsx

import com.ssafy.i10a709be.domain.member.entity.Member;
import com.ssafy.i10a709be.domain.member.enums.OAuthProvider;
import com.ssafy.i10a709be.domain.member.repository.MemberRepository;
import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@RequiredArgsConstructor
@Slf4j
public class InitService {

    private final MemberRepository memberRepository;

    @PostConstruct
    @Transactional
    public void insertInit(){
        Member member = Member.builder()
                .email("cqqudgjs@naver.com")
                .nickname("라이빵허")
                .provider(OAuthProvider.KAKAO)
                .build();
        memberRepository.save( member );
        Member findMember = memberRepository.findByEmail("cqqudgjs@naver.com").get();
        log.info( findMember.getEmail() + " 테스트 데이터 등록 완료 id: " + member.getMemberId() + " ClassName: "+ this.getClass().getName() );

    }

}
```

## 파일 레포지토리 및 서비스 생성

```jsx
package com.ssafy.i10a709be.common.entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

@Entity
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Files {

    @Id
    @GeneratedValue( strategy = GenerationType.IDENTITY )
    private Long fileId;
    private String source;
    private String name;
    private LocalDateTime createAt;
    @Column(name = "type")
    private String fileType;

}
 7 changes: 7 additions & 0 deletions7  
BE/src/main/java/com/ssafy/i10a709be/common/repository/FileRepository.java
@@ -0,0 +1,7 @@
package com.ssafy.i10a709be.common.repository;

import com.ssafy.i10a709be.common.entity.Files;
import org.springframework.data.jpa.repository.JpaRepository;

public interface FileRepository extends JpaRepository<Files, Long > {
}
  34 changes: 32 additions & 2 deletions34  
BE/src/main/java/com/ssafy/i10a709be/common/service/FileUploadServiceImpl.java
@@ -4,6 +4,7 @@
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.time.LocalDateTime;
import java.util.Objects;
import java.util.Optional;
import java.util.UUID;
@@ -12,11 +13,14 @@
import com.amazonaws.services.s3.AmazonS3Client;
import com.amazonaws.services.s3.model.CannedAccessControlList;
import com.amazonaws.services.s3.model.PutObjectRequest;
import com.ssafy.i10a709be.common.entity.Files;
import com.ssafy.i10a709be.common.exception.CustomErrorCode;
import com.ssafy.i10a709be.common.exception.CustomException;
import com.ssafy.i10a709be.common.exception.InternalServerCaughtException;
import com.ssafy.i10a709be.common.exception.InternalServerException;
import com.ssafy.i10a709be.common.repository.FileRepository;
import com.ssafy.i10a709be.common.util.ImageUtils;
import jakarta.persistence.PersistenceException;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
@@ -30,6 +34,7 @@ public class FileUploadServiceImpl implements FileUploadService {

    private static final String IMAGE_CONTENT_TYPE_PREFIX = "image";
    private final AmazonS3Client amazonS3Client;
    private final FileRepository fileRepository;

    @Value("${cloud.aws.s3.bucket}")
    private String bucket;
@@ -41,6 +46,8 @@ public String uploadFile(MultipartFile multipartFile) {
            return null;
        }
        validateIsClientSendImageFile(multipartFile);

        return uploadFiles(multipartFile, false);
    }

@@ -72,12 +79,35 @@ private String uploadFiles(MultipartFile multipartFile, boolean resize) {
        File uploadFile =
                convert(multipartFile, resize) // 파일 변환할 수 없으면 에러
                        .orElseThrow(() -> new InternalServerException("MultipartFile -> File 변환 실패", this));
        return upload(uploadFile);

        return upload(uploadFile, multipartFile.getContentType());
    }

    private String upload(File uploadFile) {
    private void saveFiles(File uploadFile, String fileName, String ext) {
        String originFileName = uploadFile.getName();
        Files fileEntity = Files.builder()
                .name( originFileName )
                .source( fileName )
                .fileType( ext )
                .createAt(LocalDateTime.now())
                .build();
        try{
            Files saved = fileRepository.save( fileEntity );
            log.info(String.valueOf(saved.getFileId()) +"번 파일 저장 성공");
        }catch( PersistenceException e ){
            log.error( "파일 저장 간 에러 발생 : " + e.getMessage() );
            throw new InternalServerException( "파일 저장 간 에러가 발생했습니다.", this );
        }

    }

    private String upload(File uploadFile, String contentType) {
        String fileName = "upload/" + UUID.randomUUID(); // S3에 저장된 파일 이름
        String uploadImageUrl = putS3(uploadFile, fileName); // s3로 업로드

        //파일 DB에 정보 저장
        saveFiles( uploadFile, uploadImageUrl, contentType );
        removeNewFile(uploadFile);
        return uploadImageUrl;
    }
 35 changes: 35 additions & 0 deletions35  
BE/src/main/java/com/ssafy/i10a709be/common/service/InitService.java
@@ -0,0 +1,35 @@
package com.ssafy.i10a709be.common.service;

import com.ssafy.i10a709be.domain.member.entity.Member;
import com.ssafy.i10a709be.domain.member.enums.OAuthProvider;
import com.ssafy.i10a709be.domain.member.repository.MemberRepository;
import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@RequiredArgsConstructor
@Slf4j
public class InitService {

    private final MemberRepository memberRepository;

    @PostConstruct
    @Transactional
    public void insertInit(){
        Member member = Member.builder()
                .email("cqqudgjs@naver.com")
                .nickname("라이빵허")
                .provider(OAuthProvider.KAKAO)
                .build();
        memberRepository.save( member );
        Member findMember = memberRepository.findByEmail("cqqudgjs@naver.com").get();
        log.info( findMember.getEmail() + " 테스트 데이터 등록 완료 id: " + member.getMemberId() + " ClassName: "+ this.getClass().getName() );
    }

}
```

## 채팅 내역 조회 서비스 생성

```jsx
package com.ssafy.i10a709be.domain.community.repository;

import com.ssafy.i10a709be.domain.community.entity.ChatRoom;
import java.util.List;
import java.util.Optional;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;

public interface ChatRoomRepository extends JpaRepository<ChatRoom, Long> {
    @Query("select crooms from ChatRoom crooms where crooms.member.memberId =: memberId")
    List<ChatRoom> findByMemberId(Long memberId);

    @Query("select crooms from ChatRoom crooms join fetch crooms.chats where crooms.chatRoomId =: chatRoomId")
    Optional<ChatRoom> findChatRoomByChatRoomIdAndChats( Long chatRoomId );

}
  3 changes: 3 additions & 0 deletions3  
BE/src/main/java/com/ssafy/i10a709be/domain/community/service/ChatService.java
@@ -5,9 +5,12 @@
import com.ssafy.i10a709be.domain.community.entity.ChatRoom;
import com.ssafy.i10a709be.domain.member.entity.Member;
import java.util.List;
import java.util.Optional;

public interface ChatService {
    List<ChatRoom> findJoinedChatRooms(Long memberId);
    Long createChatRoom(ChatRoomCreateDto chatRoomCreateDto);
    void deleteChatRoom(ChatRoomDeleteDto chatRoomDeleteDto);

    Optional<ChatRoom> findChatRoomByChatRoomIdAndChats( Long chatRoomId );
}
  11 changes: 11 additions & 0 deletions11  
BE/src/main/java/com/ssafy/i10a709be/domain/community/service/ChatServiceImpl.java
@@ -1,5 +1,6 @@
package com.ssafy.i10a709be.domain.community.service;

import com.ssafy.i10a709be.common.exception.InternalServerException;
import com.ssafy.i10a709be.domain.community.dto.ChatRoomCreateDto;
import com.ssafy.i10a709be.domain.community.dto.ChatRoomDeleteDto;
import com.ssafy.i10a709be.domain.community.entity.ChatRoom;
@@ -13,6 +14,8 @@
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.swing.text.html.Option;

@Service
@RequiredArgsConstructor
public class ChatServiceImpl implements ChatService {
@@ -51,4 +54,12 @@ public Long createChatRoom(ChatRoomCreateDto chatRoomCreateDto) {
    public void deleteChatRoom(ChatRoomDeleteDto chatRoomDeleteDto) {

    }

    @Override
    public Optional<ChatRoom> findChatRoomByChatRoomIdAndChats(Long chatRoomId) {
        Optional<ChatRoom> findChatRoom = chatRoomRepository.findChatRoomByChatRoomIdAndChats( chatRoomId );
        return Optional.of( findChatRoom ).orElseThrow( () -> new InternalServerException("해당하는 채팅방이 없습니다.", this));
    }

}
```