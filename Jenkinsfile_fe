pipeline {
    agent any

    tools {
        nodejs 'A408_FE_Build'
    }

    stages {
        stage('Build FE') {
	    when {
                expression { env.GIT_BRANCH == 'dev' }
            }
            steps {
                script {
                    // FE 폴더로 이동
                    dir('FE') {
                
                        sh 'node -v'
                        sh 'npm -v'
                        sh 'rm -rf node_modules'
                        // sh 'rm package-lock.json'
			            sh 'npm install --global pnpm'
                        sh 'pnpm i'
                        sh 'pnpm run build'
                        

                        
                    }
                }
            }
        }
    

    stage('Send Artifact'){
	    when {
                expression { env.GIT_BRANCH == 'dev' }
            }
            steps{
                sh 'ls -l'
                sh 'ls -l FE/'
                sh 'tar -cvf febuild.tar FE/**'
                sh 'ls -l'
                script{
                    sshPublisher(
                            publishers: [
                                sshPublisherDesc(
                                    configName: 'ssafycontrol',
                                    transfers: [
                                        sshTransfer(
                                            sourceFiles: 'febuild.tar',
                                            remoteDirectory: '/sendData',
                                        )
                                    ]
                                )
                            ]
                        )
                }
            }
            
        }
        stage('Continuous Delivery'){
	    when {
                expression { env.GIT_BRANCH == 'main' }
            }
            steps {
                script {
                    sh '''curl -X POST -H "Content-Type: application/json" -d '{"isBe": false}' "https://ssafycontrol.shop/control/dev/deploy"'''
                }
            }
        }
    }


    post {
        success {
            echo 'Build successful!'
        }
        failure {
            echo 'Build failed!'
        }
    }
}
